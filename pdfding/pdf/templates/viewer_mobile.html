{% load static %}
<!DOCTYPE html>
<!--
Mobile-optimized PDF viewer for PdfDing
Based on PDF.js v5.0.375 - https://github.com/mozilla/pdf.js
Licensed under the Apache License, Version 2.0
-->
<html dir="ltr" mozdisallowselectionprint>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
    <meta name="google" content="notranslate">
    <meta name="theme-color" content="rgb({{ theme_color }})">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    {# Stylesheets #}
    <link rel="stylesheet" href="../../static/pdfjs/web/viewer.css">
    <link rel="stylesheet" href="{% static 'css/pdf_viewer_mobile.css' %}">
    <link rel="icon" type="image/x-icon" href="{% static 'images/logo_with_circle.svg' %}">

    <style>
      :root {
        /* Theme colors */
        --button-hover-color: rgb({{ theme_color }});
        --progressBar-color: rgb({{ theme_color }});
        --toggled-btn-bg-color: rgb({{ theme_color }} / 0.9);
        --scrollbar-color: rgb({{ theme_color }});
        --treeitem-hover-color: rgb({{ theme_color }});
        --treeitem-selected-color: rgb({{ theme_color }});
        --thumbnail-hover-color: rgb({{ theme_color }} / 0.3);
        --thumbnail-selected-color: rgb({{ theme_color }} / 0.7);
        --button-signature-hover-bg: rgb({{ theme_color }});
        --signature-hover-bg: rgb({{ theme_color }});
        --mobile-accent-color: rgb({{ theme_color }});
      }

      .textLayer .highlight {
        --highlight-bg-color: rgb({{ theme_color }} / 0.2);
        --highlight-selected-bg-color: rgb({{ theme_color }} / 0.5);
      }

      .button1:hover {
        background-color: rgb({{ theme_color }});
      }

      .toolbarField:focus {
        border-color: rgb({{ theme_color }});
      }

      .logo {
        background: rgb({{ theme_color }});
      }

      #addSignatureDialog {
        --tab-text-active-color: rgb({{ theme_color }});
        --tab-top-line-active-color: rgb({{ theme_color }});
        --button-primary-bg-color: rgb({{ theme_color }});
        --button-primary-hover-bg-color: rgb({{ theme_color }} / 0.9);
      }
    </style>

    <script>
      (function() {
        const theme = '{{ theme }}';

        if (theme === 'system') {
          const isSystemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

          if (isSystemDark) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.add('light');
          }

          // Listen for system theme changes
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (event) => {
            document.documentElement.classList.toggle('dark', event.matches);
          });
        } else {
          document.documentElement.classList.add(theme);
        }
      })();
    </script>

    {# PDF.js core libraries #}
    <script src="../../static/pdfjs/build/pdf.mjs" type="module"></script>
    <script src="../../static/pdfjs/web/viewer.mjs" type="module"></script>

    {# Mobile-specific JavaScript #}
    <script src="{% static 'js/pdfding/viewer_base.js' %}" type="text/javascript"></script>
    {% if user_view_bool %}
    <script src="{% static 'js/pdfding/viewer_logged_in.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/pdfding/viewer_mobile.js' %}" type="text/javascript"></script>
    {% endif %}

    <script>
      // Initialize viewer
      var page_number = {{ current_page }};

      {% if user_view_bool %}
      var url = "{% url 'serve_pdf' pdf_id revision %}"
      {% else %}
      var url = "{% url 'serve_shared_pdf' shared_pdf_id revision %}"
      {% endif %}

      start_viewer(page_number, url, "{{ tab_title }}");

      {% if user_view_bool %}
      get_remote_signatures("{% url 'signatures' %}");

      // Update remote page every 3 seconds
      setInterval(update_remote_page, 3000, '{{ pdf_id }}', '{% url 'update_page' %}', '{{ csrf_token }}');

      // Update remote signatures every 5 seconds
      setInterval(update_remote_signatures, 5000, '{% url 'signatures' %}', '{{ csrf_token }}');

      {% if keep_screen_awake == 'Enabled' %}
      requestWakeLock();
      {% endif %}
      {% endif %}
    </script>

    <title>{{ tab_title }}</title>
  </head>

  <body class="mobile-viewer">
    <div id="outerContainer" class="mobile-container">

      {# Mobile Bottom Sheet Sidebar #}
      <div id="sidebarContainer" class="mobile-sidebar">
        <div id="sidebarOverlay" class="sidebar-overlay"></div>
        <div id="sidebarSheet" class="sidebar-sheet">
          <div class="sheet-handle"></div>
          <div id="toolbarSidebar" class="toolbarHorizontalGroup">
            <div id="toolbarSidebarLeft">
              <div id="sidebarViewButtons" class="toolbarHorizontalGroup toggled">
                <button id="viewThumbnail" class="toolbarButton toggled" type="button" title="Thumbnails">
                  <span>Thumbnails</span>
                </button>
                <button id="viewOutline" class="toolbarButton" type="button" title="Table of Contents">
                  <span>Outline</span>
                </button>
              </div>
            </div>
            <div id="toolbarSidebarRight">
              <button id="sidebarCloseButton" class="toolbarButton" type="button" title="Close">
                <span>Close</span>
              </button>
            </div>
          </div>
          <div id="sidebarContent">
            <div id="thumbnailView"></div>
            <div id="outlineView" class="hidden"></div>
          </div>
        </div>
      </div>

      {# Main Viewer Container #}
      <div id="mainContainer" class="mobile-main">

        {# Top Toolbar - Compact #}
        <div class="toolbar mobile-toolbar" id="mobileToolbar">
          <div id="toolbarContainer">
            <div id="toolbarViewer" class="toolbarHorizontalGroup">

              {# Left side - Back & Menu #}
              <div id="toolbarViewerLeft" class="toolbarHorizontalGroup">
                <button id="sidebarToggleButton" class="toolbarButton" type="button" title="Menu"></button>
                <div class="verticalToolbarSeparator"></div>
                <div id="pageInfoContainer" class="mobile-page-info">
                  <input type="number" id="pageNumber" class="toolbarField" value="1" size="4" min="1">
                  <span id="numPages" class="toolbarLabel"></span>
                </div>
              </div>

              {# Center - Document title #}
              <div id="toolbarViewerMiddle" class="mobile-title">
                <span id="documentTitle">{{ tab_title }}</span>
              </div>

              {# Right side - Actions #}
              <div id="toolbarViewerRight" class="toolbarHorizontalGroup">
                <button id="viewFindButton" class="toolbarButton" type="button" title="Search"></button>
                <div class="verticalToolbarSeparator"></div>
                <button id="mobileMenuButton" class="toolbarButton" type="button" title="More options"></button>
              </div>

            </div>
          </div>
        </div>

        {# Search Bar - Mobile optimized #}
        <div class="hidden doorHanger mobile-findbar" id="findbar">
          <div id="findInputContainer" class="toolbarHorizontalGroup">
            <span class="loadingInput end toolbarHorizontalGroup">
              <input id="findInput" class="toolbarField" placeholder="Search..." autocomplete="off">
            </span>
            <div class="toolbarHorizontalGroup">
              <button id="findPreviousButton" class="toolbarButton" type="button" title="Previous"></button>
              <button id="findNextButton" class="toolbarButton" type="button" title="Next"></button>
              <button id="findCloseButton" class="toolbarButton" type="button" title="Close"></button>
            </div>
          </div>
        </div>

        {# Mobile Action Menu #}
        <div id="mobileActionMenu" class="mobile-menu hidden">
          <div class="menu-overlay"></div>
          <div class="menu-content">
            <div class="menu-header">
              <span>Document Options</span>
              <button id="menuCloseButton" class="close-button">‚úï</button>
            </div>
            <div class="menu-items">
              {% if user_view_bool %}
              <button id="editorHighlight" class="menu-item" data-l10n-id="pdfjs-editor-highlight-button">
                <span class="menu-icon">üñçÔ∏è</span>
                <span class="menu-label">Highlight</span>
              </button>
              <button id="editorFreeText" class="menu-item" data-l10n-id="pdfjs-editor-free-text-button">
                <span class="menu-icon">üìù</span>
                <span class="menu-label">Add Text</span>
              </button>
              <button id="editorInk" class="menu-item" data-l10n-id="pdfjs-editor-ink-button">
                <span class="menu-icon">‚úèÔ∏è</span>
                <span class="menu-label">Draw</span>
              </button>
              <button id="editorStamp" class="menu-item" data-l10n-id="pdfjs-editor-stamp-button">
                <span class="menu-icon">‚úçÔ∏è</span>
                <span class="menu-label">Signature</span>
              </button>
              <div class="menu-divider"></div>
              {% endif %}
              <button id="presentationMode" class="menu-item">
                <span class="menu-icon">üñ•Ô∏è</span>
                <span class="menu-label">Fullscreen</span>
              </button>
              <button id="download" class="menu-item">
                <span class="menu-icon">‚¨áÔ∏è</span>
                <span class="menu-label">Download</span>
              </button>
              <button id="print" class="menu-item">
                <span class="menu-icon">üñ®Ô∏è</span>
                <span class="menu-label">Print</span>
              </button>
            </div>
          </div>
        </div>

        {# Bottom Navigation Bar #}
        <div id="mobileBottomBar" class="mobile-bottom-bar">
          <button id="previousPage" class="nav-button" type="button" title="Previous Page">
            <span>‚Üê</span>
          </button>

          <div class="zoom-controls">
            <button id="zoomOut" class="zoom-button" type="button" title="Zoom Out">
              <span>‚àí</span>
            </button>
            <select id="scaleSelect" class="zoom-select" title="Zoom">
              <option value="auto">Fit Width</option>
              <option value="page-fit">Fit Page</option>
              <option value="page-width">100%</option>
              <option value="0.5">50%</option>
              <option value="0.75">75%</option>
              <option value="1">100%</option>
              <option value="1.25">125%</option>
              <option value="1.5">150%</option>
              <option value="2">200%</option>
            </select>
            <button id="zoomIn" class="zoom-button" type="button" title="Zoom In">
              <span>+</span>
            </button>
          </div>

          <button id="nextPage" class="nav-button" type="button" title="Next Page">
            <span>‚Üí</span>
          </button>
        </div>

        {# PDF Viewer Container #}
        <div id="viewerContainer">
          <div id="viewer" class="pdfViewer"></div>
        </div>

      </div> {# mainContainer #}

      {# Loading indicator #}
      <div id="loadingBar">
        <div class="progress"></div>
        <div class="glimmer"></div>
      </div>

      {# Error wrapper #}
      <div id="errorWrapper" hidden="true">
        <div id="errorMessageLeft">
          <span id="errorMessage"></span>
          <button id="errorShowMore" data-l10n-id="pdfjs-error-more-info">More Information</button>
          <button id="errorShowLess" data-l10n-id="pdfjs-error-less-info" hidden="true">Less Information</button>
        </div>
        <div id="errorMessageRight">
          <button id="errorClose" data-l10n-id="pdfjs-error-close-button">Close</button>
        </div>
        <div class="clearBoth"></div>
        <textarea id="errorMoreInfo" hidden="true" readonly="readonly"></textarea>
      </div>

    </div> {# outerContainer #}

    {# Dialogs - Password, Signature, etc. #}
    <div id="dialogContainer">
      <dialog id="passwordDialog">
        <div class="row">
          <label for="password" id="passwordText" data-l10n-id="pdfjs-password-label">Enter password to open PDF:</label>
        </div>
        <div class="row">
          <input type="password" id="password" class="toolbarField"/>
        </div>
        <div class="buttonRow">
          <button id="passwordCancel" class="dialogButton"><span data-l10n-id="pdfjs-password-cancel-button">Cancel</span></button>
          <button id="passwordSubmit" class="dialogButton"><span data-l10n-id="pdfjs-password-ok-button">OK</span></button>
        </div>
      </dialog>

      {% if user_view_bool %}
      <dialog id="addSignatureDialog">
        <div class="dialog-content">
          <div class="dialog-header">
            <span>Add Signature</span>
            <button id="signatureCloseButton" class="close-button">‚úï</button>
          </div>
          <div class="tab-container">
            <button class="tab-button active" data-tab="draw">Draw</button>
            <button class="tab-button" data-tab="type">Type</button>
            <button class="tab-button" data-tab="upload">Upload</button>
          </div>
          <div class="tab-content">
            <div id="drawTab" class="tab-panel active">
              <canvas id="signatureCanvas" width="300" height="150"></canvas>
              <button id="clearCanvas" class="button1">Clear</button>
            </div>
            <div id="typeTab" class="tab-panel hidden">
              <input type="text" id="signatureText" class="toolbarField" placeholder="Type your signature"/>
              <div class="font-select">
                <label>Font:</label>
                <select id="signatureFont">
                  <option value="cursive">Cursive</option>
                  <option value="serif">Serif</option>
                  <option value="sans-serif">Sans-serif</option>
                </select>
              </div>
            </div>
            <div id="uploadTab" class="tab-panel hidden">
              <input type="file" id="signatureFile" accept="image/*"/>
              <div id="signaturePreview"></div>
            </div>
          </div>
          <div class="buttonRow">
            <button id="signatureCancel" class="dialogButton">Cancel</button>
            <button id="signatureSubmit" class="dialogButton button-primary">Add Signature</button>
          </div>
        </div>
      </dialog>
      {% endif %}
    </div>

    {# Print container #}
    <div id="printContainer"></div>

  </body>
</html>
